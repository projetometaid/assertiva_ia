{% extends "base.html" %}

{% block title %}Configura√ß√µes - Sistema Assertiva{% endblock %}

{% block content %}
<div class="configuracoes-container">
  <!-- Header da P√°gina -->
  <div class="config-header">
    <h1>
      <i data-lucide="settings" style="font-size: 32px; margin-right: 12px;"></i>
      Configura√ß√µes do Sistema
    </h1>
    <p>Gerencie usu√°rios, configura√ß√µes e monitore o sistema</p>
  </div>

  <!-- Modal de Confirma√ß√£o de Exclus√£o -->
  <div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-body">
        <p class="modal-title">Para confirmar a exclus√£o, digite o email do usu√°rio:</p>
        <p class="user-email" id="deleteUserEmail"></p>
        <input type="text" id="confirmEmailInput" class="modal-input" placeholder="Digite o email aqui..." autocomplete="off">
        <div id="emailError" class="error-message" style="display: none;">Email n√£o confere. Tente novamente.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn--secondary" onclick="closeDeleteModal()">Cancelar</button>
        <button type="button" class="modal-btn modal-btn--primary" onclick="confirmDelete()">OK</button>
      </div>
    </div>
  </div>

  <!-- Tabs de Navega√ß√£o -->
  <div class="config-tabs">
    <button class="config-tab active" onclick="switchTab('users')" id="tab-users">
      <i class="fas fa-users"></i>
      <span>Usu√°rios</span>
    </button>
    <button class="config-tab" onclick="switchTab('invites')" id="tab-invites">
      <i class="fas fa-user-plus"></i>
      <span>Convites</span>
    </button>
    <button class="config-tab" onclick="switchTab('system')" id="tab-system">
      <i class="fas fa-server"></i>
      <span>Sistema</span>
    </button>
  </div>

  <!-- Se√ß√£o de Usu√°rios -->
  <div id="section-users" class="config-section active">
    <div class="users-table-container">
      <div class="users-table-header">
        <h2 class="users-table-title">
          <i class="fas fa-users"></i>
          Gest√£o de Usu√°rios
        </h2>
      </div>

      <div id="usersLoading" style="display:none;" class="loading-container">
        <i class="fas fa-spinner fa-spin"></i>
        <span class="loading-text">Carregando usu√°rios...</span>
      </div>

      <div id="usersList" style="display:none;">
        <table class="table-modern">
          <thead>
            <tr>
              <th>Email</th>
              <th>Perfil</th>
              <th>Status</th>
              <th>Criado em</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>

      <div id="usersEmpty" style="display:none; padding: var(--space-8); text-align: center; color: var(--text-muted);">
        <i class="fas fa-users" style="font-size: 48px; margin-bottom: var(--space-4); opacity: 0.5;"></i>
        <p>Nenhum usu√°rio encontrado no sistema.</p>
        <small>Use a aba "Convites" para adicionar novos usu√°rios.</small>
      </div>
    </div>
  </div>

  <!-- Se√ß√£o de Convites -->
  <div id="section-invites" class="config-section">
    <div class="config-grid">
      <div class="config-card">
        <div class="config-card-header">
          <div class="config-card-icon">
            <i data-lucide="user-plus"></i>
          </div>
          <h3 class="config-card-title">Convidar Novo Usu√°rio</h3>
          <p class="config-card-description">Envie um convite para um novo usu√°rio acessar o sistema</p>
        </div>
        <div class="config-card-body">
          <form id="formConvite" class="config-form">
            <div class="config-field">
              <label class="config-label" for="emailUsuario">Email do usu√°rio</label>
              <input class="config-input" type="email" id="emailUsuario" placeholder="usuario@assertivasolucoes.com.br" required>
              <small style="color: var(--text-muted); font-size: var(--font-size-sm);">
                <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                O usu√°rio receber√° um link para definir sua senha
              </small>
            </div>
            <div class="config-actions">
              <button type="submit" class="ui-btn ui-btn--primary" id="btnGerarConvite">
                <i data-lucide="send"></i>
                Gerar Convite
              </button>
            </div>
          </form>

          <div id="mensagemContainer" style="display:none; margin-top: var(--space-4);">
            <div class="alert" id="mensagemAlert" role="alert">
              <div class="alert-icon">
                <i data-lucide="alert-circle"></i>
              </div>
              <div class="alert-content">
                <div class="alert-message" id="mensagemTexto"></div>
              </div>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>


    <!-- Resultado do Convite -->
    <div id="resultadoConvite" style="display:none; margin-top: var(--space-6);">
      <div class="config-card">
        <div class="config-card-header">
          <div class="config-card-icon" style="background: var(--success);">
            <i data-lucide="check-circle"></i>
          </div>
          <h3 class="config-card-title">Convite Gerado com Sucesso!</h3>
          <p class="config-card-description">Link de convite criado e pronto para ser compartilhado</p>
        </div>
        <div class="config-card-body">
          <div style="background: var(--gray-50); padding: var(--space-4); border-radius: var(--radius-lg); margin-bottom: var(--space-4);">
            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
              <strong>Email:</strong>
              <span id="emailGerado" style="color: var(--brand-primary);"></span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <strong>Expira em:</strong>
              <span id="expiraEm" style="color: var(--success);"></span>
            </div>
          </div>

          <div class="config-field">
            <label class="config-label">Link do convite</label>
            <div style="display: flex; gap: var(--space-2);">
              <input type="text" class="config-input" id="linkConvite" readonly style="flex: 1;">
              <button class="ui-btn ui-btn--secondary" onclick="copiarLink()" title="Copiar Link">
                <i data-lucide="copy"></i>
              </button>
            </div>
          </div>

          <div class="config-actions">
            <a href="#" id="linkAbrirConvite" target="_blank" class="ui-btn ui-btn--primary">
              <i data-lucide="external-link"></i>
              Abrir Link
            </a>
            <button type="button" class="ui-btn ui-btn--secondary" id="btnNovoConvite">
              <i data-lucide="plus"></i>
              Novo Convite
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Se√ß√£o de Sistema -->
  <div id="section-system" class="config-section">
    <div class="config-grid">
      <div class="config-card">
        <div class="config-card-header">
          <div class="config-card-icon">
            <i data-lucide="server"></i>
          </div>
          <h3 class="config-card-title">Status do Sistema</h3>
          <p class="config-card-description">Informa√ß√µes sobre o funcionamento do sistema</p>
        </div>
        <div class="config-card-body">
          <div style="display: flex; flex-direction: column; gap: var(--space-3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>Status:</span>
              <span class="status-badge status-badge--active">
                <i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>
                Operacional
              </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Vers√£o:</span>
              <span>1.0.0 (MVP)</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>√öltima atualiza√ß√£o:</span>
              <span>{{ moment().format('DD/MM/YYYY') if moment else 'N/A' }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Pr√≥xima release:</span>
              <span>Fase 2 - Autentica√ß√£o</span>
            </div>
          </div>
        </div>
      </div>

      <div class="config-card">
        <div class="config-card-header">
          <div class="config-card-icon">
            <i data-lucide="activity"></i>
          </div>
          <h3 class="config-card-title">Monitoramento</h3>
          <p class="config-card-description">M√©tricas e estat√≠sticas do sistema</p>
        </div>
        <div class="config-card-body">
          <div style="display: flex; flex-direction: column; gap: var(--space-4);">
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                <span style="font-size: var(--font-size-sm);">Usu√°rios Ativos</span>
                <span style="font-weight: var(--font-weight-semibold);">5</span>
              </div>
              <div class="progress">
                <div class="progress-bar" style="width: 60%;"></div>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                <span style="font-size: var(--font-size-sm);">Consultas Hoje</span>
                <span style="font-weight: var(--font-weight-semibold);">23</span>
              </div>
              <div class="progress">
                <div class="progress-bar" style="width: 80%;"></div>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                <span style="font-size: var(--font-size-sm);">Performance</span>
                <span style="font-weight: var(--font-weight-semibold);">95%</span>
              </div>
              <div class="progress">
                <div class="progress-bar" style="width: 95%;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
// === SISTEMA DE ABAS ===
function switchTab(tabName) {
    // Remover classe active de todas as abas
    document.querySelectorAll('.config-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Esconder todas as se√ß√µes
    document.querySelectorAll('.config-section').forEach(section => {
        section.classList.remove('active');
    });

    // Ativar aba clicada
    document.getElementById(`tab-${tabName}`).classList.add('active');

    // Mostrar se√ß√£o correspondente
    document.getElementById(`section-${tabName}`).classList.add('active');

    // Reinicializar √≠cones Lucide
    refreshIcons();
}

function mostrarMensagem(texto, tipo) {
    const container = document.getElementById('mensagemContainer');
    const alert = document.getElementById('mensagemAlert');
    const mensagem = document.getElementById('mensagemTexto');

    // Definir classe do alerta
    alert.className = `alert alert-${tipo}`;
    mensagem.textContent = texto;

    // Mostrar mensagem
    container.style.display = 'block';

    // Auto-hide ap√≥s 5 segundos
    setTimeout(() => {
        container.style.display = 'none';
    }, 5000);
}

function executarGeracao() {
    const email = document.getElementById('emailUsuario').value.trim();

    if (!email) {
        mostrarMensagem('Por favor, informe um email v√°lido', 'warning');
        return;
    }

    console.log('üìß Email:', email);

    // Mostrar loading
    const botao = document.getElementById('btnGerarConvite');
    botao.innerHTML = '<i data-lucide="loader-2"></i> Gerando...';
    if (typeof refreshIcons === 'function') {
        refreshIcons();
    }
    botao.disabled = true;

    // Esconder resultados anteriores
    document.getElementById('resultadoConvite').style.display = 'none';
    document.getElementById('mensagemContainer').style.display = 'none';

    // Fazer requisi√ß√£o
    fetch('/api/gerar-convite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    })
    .then(response => {
        console.log('üì° Status da resposta:', response.status);

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Dados:', data);

        if (data.sucesso) {
            // Mostrar resposta
            document.getElementById('emailGerado').textContent = data.email;
            document.getElementById('expiraEm').textContent = data.expira_em;
            document.getElementById('linkConvite').value = data.url;
            document.getElementById('linkAbrirConvite').href = data.url;

            // Salvar link para copiar
            window.linkParaCopiar = data.url;

            // Mostrar resultado
            document.getElementById('resultadoConvite').style.display = 'block';

            // Scroll para resultado
            document.getElementById('resultadoConvite').scrollIntoView({ behavior: 'smooth' });

            // Reinicializar √≠cones Lucide
            if (typeof refreshIcons === 'function') {
                refreshIcons();
            }

            // Limpar formul√°rio
            document.getElementById('emailUsuario').value = '';

        } else {
            mostrarMensagem('‚ùå ' + (data.erro || 'Erro desconhecido'), 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro:', error);
        mostrarMensagem('‚ùå Erro: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restaurar bot√£o
        botao.innerHTML = '<i data-lucide="user-plus"></i> Gerar Link de Convite';
        botao.disabled = false;

        // Reinicializar √≠cones Lucide
        if (typeof refreshIcons === 'function') {
            refreshIcons();
        }
    });
}

// Fun√ß√£o para copiar link
function copiarLink() {
    if (window.linkParaCopiar) {
        navigator.clipboard.writeText(window.linkParaCopiar).then(() => {
            // Feedback visual
            const botaoCopiar = document.querySelector('.btn-copy');
            const textoOriginal = botaoCopiar.innerHTML;
            botaoCopiar.innerHTML = '<i data-lucide="check"></i>';
            botaoCopiar.style.background = 'rgba(40, 167, 69, 0.8)';

            setTimeout(() => {
                botaoCopiar.innerHTML = '<i data-lucide="copy"></i>';
                botaoCopiar.style.background = 'rgba(255, 255, 255, 0.2)';
                if (typeof refreshIcons === 'function') {
                    refreshIcons();
                }
            }, 2000);

            // Reinicializar √≠cones Lucide
            if (typeof refreshIcons === 'function') {
                refreshIcons();
            }
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            mostrarMensagem('‚ùå Erro ao copiar link', 'danger');
        });
    }
}

// ===== GEST√ÉO DE USU√ÅRIOS =====

// Fun√ß√£o de teste simples
function testeSimples() {
    alert('‚úÖ Fun√ß√£o testeSimples() funcionou!');
}

// Nova fun√ß√£o para carregar usu√°rios
function carregarUsuarios() {
    alert('üéØ carregarUsuarios() foi chamada!');
}

function loadUsers() {
    console.log('üöÄ loadUsers() chamada!');

    const usersList = document.getElementById('usersList');
    const usersLoading = document.getElementById('usersLoading');
    const usersEmpty = document.getElementById('usersEmpty');
    const usersTableBody = document.getElementById('usersTableBody');

    // Mostrar loading e esconder outros elementos
    usersList.style.display = 'none';
    usersEmpty.style.display = 'none';
    usersLoading.style.display = 'block';

    // Usar fetch sem async/await
    fetch('/api/users', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('üì° Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Data received:', data);

        if (data.sucesso) {
            console.log('‚úÖ Resposta OK, processando usu√°rios...');

            // Limpar tabela
            usersTableBody.innerHTML = '';
            console.log('üßπ Tabela limpa');

            console.log('üë• Usu√°rios encontrados:', data.users.length);
            console.log('üìã Lista de usu√°rios:', data.users);

            // Adicionar usu√°rios
            data.users.forEach((user, index) => {
                console.log(`üë§ Processando usu√°rio ${index + 1}:`, user);
                const row = document.createElement('tr');

                // Criar c√©lulas
                const emailCell = document.createElement('td');
                emailCell.textContent = user.email;

                const roleCell = document.createElement('td');
                const roleBadge = document.createElement('span');
                roleBadge.className = `badge ${user.role === 'admin' ? 'badge--primary' : 'badge--secondary'}`;
                roleBadge.textContent = user.role === 'admin' ? 'Administrador' : 'Usu√°rio';

                // Verificar se √© o email protegido
                const protectedEmail = 'leandro.albertini@assertivasolucoes.com.br';
                const isProtected = user.email === protectedEmail;
                console.log(`üõ°Ô∏è Usu√°rio ${user.email} protegido:`, isProtected);

                if (isProtected) {
                    roleBadge.style.cursor = 'default';
                    roleBadge.title = 'Usu√°rio protegido - perfil n√£o pode ser alterado';
                } else {
                    roleBadge.style.cursor = 'pointer';
                    roleBadge.title = 'Clique para alterar perfil';
                    roleBadge.onclick = () => toggleUserRole(user.id, user.role);
                }

                roleCell.appendChild(roleBadge);

                const statusCell = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-badge--active';
                const statusIcon = document.createElement('i');
                statusIcon.setAttribute('data-lucide', 'check-circle');
                statusBadge.appendChild(statusIcon);
                statusBadge.appendChild(document.createTextNode(' Ativo'));
                statusCell.appendChild(statusBadge);

                const dateCell = document.createElement('td');
                dateCell.textContent = new Date(user.createdAt).toLocaleDateString('pt-BR');

                const actionsCell = document.createElement('td');

                // Verificar se √© o email protegido
                const protectedEmail = 'leandro.albertini@assertivasolucoes.com.br';
                const isProtected = user.email === protectedEmail;

                if (isProtected) {
                    // Mostrar √≠cone de prote√ß√£o em vez do bot√£o de excluir
                    const protectedIcon = document.createElement('span');
                    protectedIcon.className = 'protected-user';
                    protectedIcon.title = 'Usu√°rio protegido - n√£o pode ser exclu√≠do';
                    protectedIcon.innerHTML = '<i data-lucide="shield-check" style="color: #10b981; width: 16px; height: 16px;"></i>';
                    actionsCell.appendChild(protectedIcon);
                } else {
                    // Mostrar bot√£o de excluir normalmente
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'ui-btn ui-btn--xs ui-btn--danger';
                    deleteBtn.title = 'Remover usu√°rio';
                    deleteBtn.onclick = () => {
                        console.log('üñ±Ô∏è Bot√£o excluir clicado para:', { id: user.id, email: user.email });
                        deleteUser(user.id, user.email);
                    };
                    const deleteIcon = document.createElement('i');
                    deleteIcon.setAttribute('data-lucide', 'trash-2');
                    deleteBtn.appendChild(deleteIcon);
                    actionsCell.appendChild(deleteBtn);
                }

                // Adicionar c√©lulas √† linha
                row.appendChild(emailCell);
                row.appendChild(roleCell);
                row.appendChild(statusCell);
                row.appendChild(dateCell);
                row.appendChild(actionsCell);

                usersTableBody.appendChild(row);
                console.log(`‚úÖ Linha ${index + 1} adicionada para usu√°rio:`, user.email);
                console.log('üìã DOM da linha:', row.outerHTML.substring(0, 200) + '...');
            });

            // Reinicializar √≠cones Lucide ap√≥s adicionar o HTML
            setTimeout(() => {
                console.log('üîç Verificando Lucide...', {
                    windowLucide: !!window.lucide,
                    createIcons: !!(window.lucide && window.lucide.createIcons),
                    iconesComDataLucide: document.querySelectorAll('[data-lucide]').length
                });

                // Usar a fun√ß√£o global refreshIcons
                if (typeof refreshIcons === 'function') {
                    refreshIcons();
                    console.log('üîÑ √çcones reinicializados ap√≥s carregar usu√°rios');

                    // Verificar se os √≠cones foram renderizados
                    setTimeout(() => {
                        const iconesRenderizados = document.querySelectorAll('[data-lucide="trash-2"] svg').length;
                        console.log(`üìä √çcones trash-2 renderizados: ${iconesRenderizados}`);
                    }, 100);
                } else {
                    console.error('‚ùå refreshIcons n√£o dispon√≠vel');
                }
            }, 200);

            // Mostrar lista se h√° usu√°rios, sen√£o mostrar mensagem vazia
            usersLoading.style.display = 'none';
            if (data.users.length > 0) {
                usersList.style.display = 'block';
                usersEmpty.style.display = 'none';
            } else {
                usersList.style.display = 'none';
                usersEmpty.style.display = 'block';
            }

        } else {
            throw new Error(data.erro || 'Erro na resposta da API');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar usu√°rios:', error);
        usersLoading.style.display = 'none';
        usersList.style.display = 'block';
        usersEmpty.style.display = 'none';
        usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--danger); padding: var(--space-8);">Erro ao carregar usu√°rios: ' + error.message + '</td></tr>';
    });
}

async function toggleUserRole(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    const roleText = newRole === 'admin' ? 'Administrador' : 'Usu√°rio';

    if (confirm(`Alterar perfil para ${roleText}?`)) {
        await updateUserRole(userId, newRole);
        loadUsers(); // Recarregar lista para mostrar mudan√ßa
    }
}

async function updateUserRole(userId, newRole) {
    try {
        const response = await fetch(`/users/${userId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ role: newRole })
        });

        const data = await response.json();

        if (response.ok) {
            mostrarMensagem(`‚úÖ Perfil atualizado para ${newRole}`, 'success');
        } else {
            throw new Error(data.erro || 'Erro ao atualizar perfil');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('‚ùå Erro ao atualizar perfil: ' + error.message, 'danger');
        // Recarregar usu√°rios para reverter mudan√ßa
        loadUsers();
    }
}

// Vari√°veis globais para o modal de exclus√£o
let deleteUserId = null;
let deleteUserEmailValue = null;

function deleteUser(userId, userEmail) {
    console.log('üóëÔ∏è deleteUser chamada:', { userId, userEmail });

    deleteUserId = userId;
    deleteUserEmailValue = userEmail;

    // Verificar se elementos existem
    const emailElement = document.getElementById('deleteUserEmail');
    const inputElement = document.getElementById('confirmEmailInput');
    const errorElement = document.getElementById('emailError');
    const modalElement = document.getElementById('deleteModal');

    console.log('üìã Elementos encontrados:', {
        emailElement: !!emailElement,
        inputElement: !!inputElement,
        errorElement: !!errorElement,
        modalElement: !!modalElement
    });

    if (!modalElement) {
        console.error('‚ùå Modal n√£o encontrado!');
        return;
    }

    // Mostrar email no modal
    if (emailElement) {
        emailElement.textContent = userEmail;
    }

    // Limpar input e erro
    if (inputElement) {
        inputElement.value = '';
    }
    if (errorElement) {
        errorElement.style.display = 'none';
    }

    // Mostrar modal
    modalElement.style.display = 'flex';
    console.log('‚úÖ Modal exibido');

    // Focar no input
    setTimeout(() => {
        if (inputElement) {
            inputElement.focus();
        }
    }, 100);
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    document.getElementById('confirmEmailInput').value = '';
    document.getElementById('emailError').style.display = 'none';
    deleteUserId = null;
    deleteUserEmailValue = null;
}

async function confirmDelete() {
    if (!deleteUserId || !deleteUserEmailValue) return;

    const inputEmail = document.getElementById('confirmEmailInput').value.trim();
    const errorDiv = document.getElementById('emailError');

    // Verificar se o email confere
    if (inputEmail !== deleteUserEmailValue) {
        errorDiv.style.display = 'block';
        document.getElementById('confirmEmailInput').focus();
        return;
    }

    // Esconder erro se estava vis√≠vel
    errorDiv.style.display = 'none';

    try {
        const response = await fetch(`/users/${deleteUserId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirmation: inputEmail })
        });

        const data = await response.json();

        if (response.ok) {
            mostrarMensagem('‚úÖ Usu√°rio removido com sucesso', 'success');
            loadUsers(); // Recarregar lista
            closeDeleteModal();
        } else {
            throw new Error(data.erro || 'Erro ao remover usu√°rio');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('‚ùå Erro ao remover usu√°rio: ' + error.message, 'danger');
        closeDeleteModal();
    }
}

// A fun√ß√£o refreshIcons j√° est√° definida no base.html

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Configura√ß√µes: DOMContentLoaded');

    // Verificar se elementos existem
    const usersList = document.getElementById('usersList');
    const usersLoading = document.getElementById('usersLoading');
    const usersEmpty = document.getElementById('usersEmpty');
    const usersTableBody = document.getElementById('usersTableBody');

    console.log('üìã Elementos encontrados:', {
        usersList: !!usersList,
        usersLoading: !!usersLoading,
        usersEmpty: !!usersEmpty,
        usersTableBody: !!usersTableBody
    });

    // Aguardar o Lucide carregar antes de inicializar
    if (typeof waitForLucide === 'function') {
        waitForLucide(() => {
            // Inicializar √≠cones
            refreshIcons();

            // Carregar usu√°rios automaticamente ao abrir a p√°gina
            loadUsers();
        });
    } else {
        // Fallback se waitForLucide n√£o estiver dispon√≠vel
        setTimeout(() => {
            refreshIcons();
            loadUsers();
        }, 300);
    }

    // Submiss√£o do formul√°rio
    document.getElementById('formConvite').addEventListener('submit', function(e) {
        e.preventDefault();
        executarGeracao();
    });

    // Novo convite
    document.getElementById('btnNovoConvite').addEventListener('click', function() {
        document.getElementById('resultadoConvite').style.display = 'none';
        document.getElementById('mensagemContainer').style.display = 'none';
        document.getElementById('emailUsuario').focus();
    });

    // Atalho Ctrl+Enter
    document.getElementById('emailUsuario').addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            executarGeracao();
        }
    });
});

// Fun√ß√£o para carregar usu√°rios (movida para o final)
function carregarUsuariosFinal() {
    alert('üéØ carregarUsuariosFinal() funcionou!');
    console.log('üéØ Fun√ß√£o no final do script executada');
}

// Tornar a fun√ß√£o global
window.carregarUsuariosFinal = carregarUsuariosFinal;

// Fun√ß√£o de teste para debug
window.testModal = function() {
    console.log('üß™ Testando modal...');
    const modal = document.getElementById('deleteModal');
    console.log('Modal encontrado:', !!modal);
    if (modal) {
        modal.style.display = 'flex';
        console.log('‚úÖ Modal exibido para teste');
    } else {
        console.error('‚ùå Modal n√£o encontrado!');
    }
};

// Fun√ß√£o de teste para API
window.testAPI = function() {
    console.log('üß™ Testando API de usu√°rios...');
    fetch('/api/users', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('üì° Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä API Data:', data);
    })
    .catch(error => {
        console.error('‚ùå API Error:', error);
    });
};

// Fun√ß√£o simplificada para debug
window.loadUsersSimple = function() {
    console.log('üîß loadUsersSimple() chamada');

    const usersTableBody = document.getElementById('usersTableBody');
    if (!usersTableBody) {
        console.error('‚ùå usersTableBody n√£o encontrado!');
        return;
    }

    // Limpar tabela
    usersTableBody.innerHTML = '';

    // Adicionar uma linha de teste
    const testRow = document.createElement('tr');
    testRow.innerHTML = `
        <td>teste@exemplo.com</td>
        <td><span class="badge badge--primary">Administrador</span></td>
        <td><span class="status-badge status-badge--active"><i data-lucide="check-circle"></i> Ativo</span></td>
        <td>30/08/2025</td>
        <td><button class="ui-btn ui-btn--xs ui-btn--danger"><i data-lucide="trash-2"></i></button></td>
    `;

    usersTableBody.appendChild(testRow);
    console.log('‚úÖ Linha de teste adicionada');

    // Mostrar tabela
    const usersList = document.getElementById('usersList');
    if (usersList) {
        usersList.style.display = 'block';
        console.log('‚úÖ Tabela exibida');
    }

    // Inicializar √≠cones
    if (typeof refreshIcons === 'function') {
        refreshIcons();
        console.log('‚úÖ √çcones inicializados');
    }
};

// Fechar modal ao clicar fora dele
document.addEventListener('click', function(event) {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
        closeDeleteModal();
    }
});

// Permitir confirmar com Enter no input do email
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && document.getElementById('deleteModal').style.display === 'flex') {
        confirmDelete();
    }
    if (event.key === 'Escape' && document.getElementById('deleteModal').style.display === 'flex') {
        closeDeleteModal();
    }
});

// Limpar erro quando usu√°rio digita
document.addEventListener('input', function(event) {
    if (event.target.id === 'confirmEmailInput') {
        document.getElementById('emailError').style.display = 'none';
    }
});

</script>



<style>
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: #2a2a2a;
  border-radius: 12px;
  padding: 0;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  color: white;
}

.modal-body {
  padding: 24px;
}

.modal-title {
  margin: 0 0 8px 0;
  color: #ffffff;
  font-size: 16px;
  font-weight: 400;
  line-height: 1.4;
}

.user-email {
  margin: 0 0 16px 0;
  color: #ffffff;
  font-size: 14px;
  font-weight: 500;
}

.modal-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #4a90e2;
  border-radius: 8px;
  background: #1a1a1a;
  color: white;
  font-size: 14px;
  outline: none;
  box-sizing: border-box;
  margin-bottom: 8px;
}

.modal-input:focus {
  border-color: #5ba0f2;
  box-shadow: 0 0 0 3px rgba(75, 144, 226, 0.1);
}

.modal-input::placeholder {
  color: #888;
}

.error-message {
  color: #ff6b6b;
  font-size: 12px;
  margin-top: 4px;
}

.modal-footer {
  padding: 16px 24px 24px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.modal-btn {
  padding: 10px 24px;
  border: none;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 80px;
}

.modal-btn--secondary {
  background: #4a4a4a;
  color: white;
}

.modal-btn--secondary:hover {
  background: #5a5a5a;
}

.modal-btn--primary {
  background: #4a90e2;
  color: white;
}

.modal-btn--primary:hover {
  background: #5ba0f2;
}

.modal-btn--primary:disabled {
  background: #666;
  cursor: not-allowed;
  opacity: 0.6;
}

/* Estilo para usu√°rio protegido */
.protected-user {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  border-radius: 4px;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
  cursor: help;
}
</style>

{% endblock %}
