{% extends "base.html" %}

{% block title %}Configura√ß√µes - Sistema Assertiva{% endblock %}

{% block content %}
<!-- Gest√£o de Usu√°rios -->
<div class="ui-card">
  <div class="ui-card__header">Gest√£o de Usu√°rios
    <button class="ui-btn ui-btn--primary ui-btn--sm" style="float:right; margin-left: 10px;" onclick="loadUsers();">
      <i data-lucide="users" class="lucide-icon"></i>
      <i class="fas fa-users fallback-icon" style="display: none;"></i>
      Ver Usu√°rios
    </button>
    <button class="ui-btn ui-btn--secondary ui-btn--sm" style="float:right" onclick="testeSimples();">
      <i data-lucide="test-tube" class="lucide-icon"></i>
      <i class="fas fa-flask fallback-icon" style="display: none;"></i>
      Teste Simples
    </button>
  </div>
  <div class="ui-card__body">
    <p class="u-text-muted">Gerencie usu√°rios do sistema</p>

    <div id="usersList" style="display:none;">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Email</th><th>Nome</th><th>Perfil</th><th>Criado em</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="usersLoading" style="display:none;" class="text-center">
      <i data-lucide="loader-2"></i> Carregando usu√°rios...
    </div>
  </div>
</div>

<!-- Formul√°rio de Convite -->
<div class="ui-card">
  <div class="ui-card__header">Convidar Novo Usu√°rio</div>
  <div class="ui-card__body">
    <form id="formConvite">
      <label class="ui-label" for="emailUsuario">Email do usu√°rio:</label>
      <input class="ui-input" type="email" id="emailUsuario" placeholder="usuario@exemplo.com" required>
      <small class="u-text-muted">O usu√°rio receber√° um link para definir sua senha</small>
      <div class="ui-actions">
        <button type="submit" class="ui-btn ui-btn--primary" id="btnGerarConvite">
          <i data-lucide="user-plus"></i> Gerar Link de Convite
        </button>
      </div>
    </form>

    <div class="mt-3" id="mensagemContainer" style="display:none;">
      <div class="alert alert-danger" id="mensagemAlert" role="alert">
        <span id="mensagemTexto"></span>
      </div>
    </div>
  </div>
</div>


<!-- √Årea de resultado do convite -->
<div id="resultadoConvite" style="display:none;">
  <div class="card">
    <div class="card-header d-flex justify-content-end">
      <button class="btn btn-outline btn-sm" onclick="copiarLink()" style="margin-left:auto;">
        <i data-lucide="copy"></i>
      </button>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <strong>Email:</strong> <span id="emailGerado" class="text-primary"></span><br>
        <strong>Expira em:</strong> <span id="expiraEm" class="text-success"></span>
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Link do convite</label>
        <input type="text" class="input" id="linkConvite" readonly>
      </div>
      <div class="d-flex gap-2 justify-content-center">
        <a href="#" id="linkAbrirConvite" target="_blank" class="btn btn-primary">
          <i data-lucide="external-link"></i> Abrir Link
        </a>
        <button type="button" class="btn btn-outline" id="btnNovoConvite">
          <i data-lucide="plus"></i> Novo Convite
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Card de Informa√ß√µes -->
<div class="card">
  <div class="card-header">Como Funciona</div>
  <div class="card-body">
    <div class="d-flex flex-column gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="badge-num">01</div>
        <div>
          <strong>Digite o email</strong><br>
          <small class="text-muted">Informe o email do novo usu√°rio</small>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="badge-num">02</div>
        <div>
          <strong>Gere o link</strong><br>
          <small class="text-muted">Clique em "Gerar Link de Convite"</small>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="badge-num">03</div>
        <div>
          <strong>Compartilhe</strong><br>
          <small class="text-muted">Envie o link para o usu√°rio</small>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="badge-num">04</div>
        <div>
          <strong>Usu√°rio define senha</strong><br>
          <small class="text-muted">O usu√°rio acessa o link e cria sua senha</small>
        </div>
      </div>
    </div>
  </div>
</div>

</div>


<script>
function mostrarMensagem(texto, tipo) {
    const container = document.getElementById('mensagemContainer');
    const alert = document.getElementById('mensagemAlert');
    const mensagem = document.getElementById('mensagemTexto');

    // Definir classe do alerta
    alert.className = `alert alert-${tipo}`;
    mensagem.textContent = texto;

    // Mostrar mensagem
    container.style.display = 'block';

    // Auto-hide ap√≥s 5 segundos
    setTimeout(() => {
        container.style.display = 'none';
    }, 5000);
}

function executarGeracao() {
    const email = document.getElementById('emailUsuario').value.trim();

    if (!email) {
        mostrarMensagem('Por favor, informe um email v√°lido', 'warning');
        return;
    }

    console.log('üìß Email:', email);

    // Mostrar loading
    const botao = document.getElementById('btnGerarConvite');
    botao.innerHTML = '<i data-lucide="loader-2"></i> Gerando...';
    if (typeof initLucideIcons === 'function') {
        initLucideIcons();
    }
    botao.disabled = true;

    // Esconder resultados anteriores
    document.getElementById('resultadoConvite').style.display = 'none';
    document.getElementById('mensagemContainer').style.display = 'none';

    // Fazer requisi√ß√£o
    fetch('/api/gerar-convite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    })
    .then(response => {
        console.log('üì° Status da resposta:', response.status);

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Dados:', data);

        if (data.sucesso) {
            // Mostrar resposta
            document.getElementById('emailGerado').textContent = data.email;
            document.getElementById('expiraEm').textContent = data.expira_em;
            document.getElementById('linkConvite').value = data.url;
            document.getElementById('linkAbrirConvite').href = data.url;

            // Salvar link para copiar
            window.linkParaCopiar = data.url;

            // Mostrar resultado
            document.getElementById('resultadoConvite').style.display = 'block';

            // Scroll para resultado
            document.getElementById('resultadoConvite').scrollIntoView({ behavior: 'smooth' });

            // Reinicializar √≠cones Lucide
            if (typeof initLucideIcons === 'function') {
                initLucideIcons();
            }

            // Limpar formul√°rio
            document.getElementById('emailUsuario').value = '';

        } else {
            mostrarMensagem('‚ùå ' + (data.erro || 'Erro desconhecido'), 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro:', error);
        mostrarMensagem('‚ùå Erro: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restaurar bot√£o
        botao.innerHTML = '<i data-lucide="user-plus"></i> Gerar Link de Convite';
        botao.disabled = false;

        // Reinicializar √≠cones Lucide
        if (typeof initLucideIcons === 'function') {
            initLucideIcons();
        }
    });
}

// Fun√ß√£o para copiar link
function copiarLink() {
    if (window.linkParaCopiar) {
        navigator.clipboard.writeText(window.linkParaCopiar).then(() => {
            // Feedback visual
            const botaoCopiar = document.querySelector('.btn-copy');
            const textoOriginal = botaoCopiar.innerHTML;
            botaoCopiar.innerHTML = '<i data-lucide="check"></i>';
            botaoCopiar.style.background = 'rgba(40, 167, 69, 0.8)';

            setTimeout(() => {
                botaoCopiar.innerHTML = '<i data-lucide="copy"></i>';
                botaoCopiar.style.background = 'rgba(255, 255, 255, 0.2)';
                if (typeof initLucideIcons === 'function') {
                    initLucideIcons();
                }
            }, 2000);

            // Reinicializar √≠cones Lucide
            if (typeof initLucideIcons === 'function') {
                initLucideIcons();
            }
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            mostrarMensagem('‚ùå Erro ao copiar link', 'danger');
        });
    }
}

// ===== GEST√ÉO DE USU√ÅRIOS =====

// Fun√ß√£o de teste simples
function testeSimples() {
    alert('‚úÖ Fun√ß√£o testeSimples() funcionou!');
}

// Nova fun√ß√£o para carregar usu√°rios
function carregarUsuarios() {
    alert('üéØ carregarUsuarios() foi chamada!');
}

function loadUsers() {
    alert('üöÄ loadUsers() foi chamada!');
    console.log('üöÄ loadUsers() chamada!');

    const usersList = document.getElementById('usersList');
    const usersLoading = document.getElementById('usersLoading');
    const usersTableBody = document.getElementById('usersTableBody');

    // Mostrar loading
    usersList.style.display = 'none';
    usersLoading.style.display = 'block';

    // Usar fetch sem async/await
    fetch('/api/users', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('üì° Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Data received:', data);

        if (data.sucesso) {
            console.log('‚úÖ Resposta OK, processando usu√°rios...');

            // Limpar tabela
            usersTableBody.innerHTML = '';

            console.log('üë• Usu√°rios encontrados:', data.users.length);

            // Adicionar usu√°rios
            data.users.forEach(user => {
                console.log('üë§ Processando usu√°rio:', user);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${user.role === 'admin' ? 'Administrador' : 'Usu√°rio'}</td>
                    <td><span class="badge bg-success">Ativo</span></td>
                    <td>${new Date(user.createdAt).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <button class="ui-btn ui-btn--sm ui-btn--danger" onclick="alert('Remover usu√°rio')">
                            Remover
                        </button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });

            // Mostrar lista
            usersLoading.style.display = 'none';
            usersList.style.display = 'block';

            // Reinicializar √≠cones
            if (typeof window.refreshIcons === 'function') {
                window.refreshIcons();
            }

        } else {
            throw new Error(data.erro || 'Erro na resposta da API');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao carregar usu√°rios:', error);
        usersLoading.style.display = 'none';
        usersList.style.display = 'block';
        usersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar usu√°rios: ' + error.message + '</td></tr>';
    });
}

async function updateUserRole(userId, newRole) {
    try {
        const response = await fetch(`/users/${userId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ role: newRole })
        });

        const data = await response.json();

        if (response.ok) {
            mostrarMensagem(`‚úÖ Perfil atualizado para ${newRole}`, 'success');
        } else {
            throw new Error(data.erro || 'Erro ao atualizar perfil');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('‚ùå Erro ao atualizar perfil: ' + error.message, 'danger');
        // Recarregar usu√°rios para reverter mudan√ßa
        loadUsers();
    }
}

async function deleteUser(userId, userEmail) {
    // Confirmar exclus√£o
    const confirmation = prompt(`Para confirmar a exclus√£o, digite o email do usu√°rio:\n${userEmail}`);

    if (confirmation !== userEmail) {
        mostrarMensagem('‚ùå Confirma√ß√£o inv√°lida', 'warning');
        return;
    }

    try {
        const response = await fetch(`/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirmation: confirmation })
        });

        const data = await response.json();

        if (response.ok) {
            mostrarMensagem('‚úÖ Usu√°rio removido com sucesso', 'success');
            loadUsers(); // Recarregar lista
        } else {
            throw new Error(data.erro || 'Erro ao remover usu√°rio');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('‚ùå Erro ao remover usu√°rio: ' + error.message, 'danger');
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Submiss√£o do formul√°rio
    document.getElementById('formConvite').addEventListener('submit', function(e) {
        e.preventDefault();
        executarGeracao();
    });

    // Novo convite
    document.getElementById('btnNovoConvite').addEventListener('click', function() {
        document.getElementById('resultadoConvite').style.display = 'none';
        document.getElementById('mensagemContainer').style.display = 'none';
        document.getElementById('emailUsuario').focus();
    });

    // Atalho Ctrl+Enter
    document.getElementById('emailUsuario').addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            executarGeracao();
        }
    });
});

// Fun√ß√£o para carregar usu√°rios (movida para o final)
function carregarUsuariosFinal() {
    alert('üéØ carregarUsuariosFinal() funcionou!');
    console.log('üéØ Fun√ß√£o no final do script executada');
}

// Tornar a fun√ß√£o global
window.carregarUsuariosFinal = carregarUsuariosFinal;

</script>

{% endblock %}
