<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema Apoio Atendimento - Assertiva{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

    <!-- Favicons Assertiva -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='assets/favicons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='assets/favicons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='assets/favicons/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='assets/favicons/site.webmanifest') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='assets/favicons/favicon.ico') }}">


</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Header -->
        <div class="sidebar-header">
            <div class="d-flex align-items-center">
                <div class="sidebar-logo">
                    <img src="{{ url_for('static', filename='assets/logos/logo _assertiva.png') }}" alt="Assertiva" />
                </div>
                <span class="sidebar-title">Assertiva</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="bi bi-chevron-left"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="{{ url_for('atendimento') }}" class="nav-link {{ 'active' if request.endpoint == 'atendimento' }}">
                    <div class="nav-icon">üí¨</div>
                    <span class="nav-text">Atendimento</span>
                </a>
            </div>
            <!-- Admin removido na vers√£o local -->

            <!-- Hist√≥rico Item (only on atendimento page) -->
            {% if request.endpoint == 'atendimento' %}
            <div class="nav-item">
                <a href="#" class="nav-link" id="historicoToggle" onclick="toggleHistorico()">
                    <div class="nav-icon">üïí</div>
                    <span class="nav-text">Hist√≥rico</span>
                </a>
            </div>
            {% endif %}
        </nav>

        <!-- Footer with Logout -->
        <div class="sidebar-footer">
            {% if user %}
            <div class="nav-item">
                <a href="#" class="nav-link logout-link"
                   style="cursor: pointer; background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 8px; transition: all 0.3s ease;"
                   onmouseover="this.style.background='rgba(255,0,0,0.2)'"
                   onmouseout="this.style.background='rgba(255,0,0,0.1)'">
                    <div class="nav-icon">üö™</div>
                    <span class="nav-text">Sair</span>
                </a>
            </div>
            {% else %}
            <div class="nav-item">
                <div class="nav-link" style="opacity: 0.7;">
                    <div class="nav-icon">üè†</div>
                    <span class="nav-text">Vers√£o Local</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Sidebar Hist√≥rico -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-sidebar-header">
            <h5 class="mb-0">üìã Hist√≥rico de Perguntas</h5>
            <button class="close-sidebar" onclick="closeHistorySidebar()">√ó</button>
        </div>
        <div class="history-sidebar-body" id="historicoContainer">
            <div style="text-align: center; color: #6c757d; padding: 2rem;">
                Nenhuma pergunta ainda
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            // Para mobile
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            }
        }

        // Auto-hide sidebar on mobile when clicking outside
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const mobileToggle = document.querySelector('.mobile-toggle');

                if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });

        // Fun√ß√µes da Sidebar Hist√≥rico
        function toggleHistorico() {
            console.log('üîç toggleHistorico chamado!');
            const sidebar = document.getElementById('historySidebar');
            const logo = document.querySelector('.sidebar-logo');
            console.log('üìã Sidebar encontrada:', sidebar);

            if (sidebar) {
                sidebar.classList.add('show');
                console.log('‚úÖ Classe "show" adicionada √† sidebar');

                // Expandir logo para mostrar nome completo
                if (logo) {
                    logo.classList.add('expanded');
                    console.log('üé® Logo expandido');
                }

                // Carregar hist√≥rico se existir
                if (window.sistemaAtendimento) {
                    console.log('üìö Carregando hist√≥rico...');
                    window.sistemaAtendimento.carregarHistorico();
                } else {
                    console.log('‚ö†Ô∏è sistemaAtendimento n√£o encontrado');
                }
            } else {
                console.log('‚ùå Sidebar n√£o encontrada!');
            }
        }

        function closeHistorySidebar() {
            console.log('üîí closeHistorySidebar chamado!');
            const sidebar = document.getElementById('historySidebar');
            const logo = document.querySelector('.sidebar-logo');

            if (sidebar) {
                sidebar.classList.remove('show');
                console.log('‚úÖ Sidebar fechada');

                // Recolher logo de volta ao favicon
                if (logo) {
                    logo.classList.remove('expanded');
                    console.log('üé® Logo recolhido');
                }
            } else {
                console.log('‚ùå Sidebar n√£o encontrada para fechar!');
            }
        }

        // Fechar modal clicando fora
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistoryModal();
            }
        });

        // Inicializar √≠cones Lucide ap√≥s DOM carregado
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
    <!-- <script src="{{ url_for('static', filename='js/app.js') }}"> TEMPORARIAMENTE REMOVIDO --></script>

    <!-- Script de logout -->
    <script>
        function fazerLogout() {
            console.log('üö™ Iniciando logout...');

            // Feedback visual imediato
            const logoutLink = document.querySelector('.logout-link');
            if (logoutLink) {
                logoutLink.innerHTML = '<div class="nav-icon">‚è≥</div><span class="nav-text">Saindo...</span>';
                logoutLink.style.pointerEvents = 'none';
            }

            // Desabilitar temporariamente os scripts de seguran√ßa
            window.logoutInProgress = true;

            // Limpar dados do navegador imediatamente
            if (typeof(Storage) !== "undefined") {
                localStorage.clear();
                sessionStorage.clear();
            }

            // M√©todo direto: usar window.location.href para rota GET de logout
            console.log('üåê Redirecionando para logout via GET...');
            window.location.href = '/logout-get';
        }

        // Event listener para o bot√£o
        document.addEventListener('DOMContentLoaded', function() {
            const logoutLink = document.querySelector('.logout-link');
            if (logoutLink) {
                console.log('‚úÖ Bot√£o logout encontrado e configurado');

                logoutLink.addEventListener('click', function(e) {
                    console.log('üñ±Ô∏è Clique no logout detectado');
                    e.preventDefault();
                    e.stopPropagation();
                    fazerLogout();
                    return false;
                });
            } else {
                console.log('‚ùå Bot√£o logout n√£o encontrado!');
            }
        });
    </script>

    <!-- Script de seguran√ßa para prevenir acesso ap√≥s logout -->
    <script>
        // Detectar quando a p√°gina √© carregada do cache (bot√£o voltar)
        window.addEventListener('pageshow', function(event) {
            // N√£o interferir se logout est√° em progresso
            if (window.logoutInProgress) return;

            if (event.persisted) {
                // P√°gina foi carregada do cache - for√ßar reload
                window.location.reload();
            }
        });

        // Detectar navega√ß√£o pelo hist√≥rico
        window.addEventListener('popstate', function(event) {
            // N√£o interferir se logout est√° em progresso
            if (window.logoutInProgress) return;

            // Verificar se ainda est√° autenticado fazendo uma requisi√ß√£o
            fetch('/', {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            }).then(response => {
                if (response.redirected && response.url.includes('/login')) {
                    // N√£o est√° mais autenticado - redirecionar
                    window.location.href = '/login';
                }
            }).catch(() => {
                // Erro - redirecionar para login
                window.location.href = '/login';
            });
        });

        // Prevenir cache da p√°gina
        if (window.history && window.history.pushState) {
            window.addEventListener('beforeunload', function() {
                // Limpar cache ao sair da p√°gina
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        names.forEach(function(name) {
                            caches.delete(name);
                        });
                    });
                }
            });
        }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>