{% extends "base.html" %}

{% block title %}Atendimento - Sistema Apoio Assertiva{% endblock %}

{% block content %}
<div class="atendimento-container">
  <div class="pergunta-card">
    <div class="card-header">
      <i data-lucide="message-square"></i>
      <h3 class="card-header-title">Pergunta do Cliente</h3>
    </div>
    <div class="card-body">
      <textarea class="pergunta-textarea" id="perguntaInput" rows="5"
                placeholder="Cole aqui a pergunta do cliente ou descreva a situa√ß√£o que precisa de apoio..."></textarea>

      <div class="ui-actions">
        <button type="button" class="ui-btn ui-btn--primary ui-btn--lg" id="botaoGerarResposta" onclick="executarGeracao()">
          <i data-lucide="send"></i>
          Gerar Resposta Inteligente
        </button>
      </div>
    </div>

    <div id="mensagemContainer" style="display:none;">
      <div class="alert" id="mensagemAlert" role="alert">
        <div class="alert-icon">
          <i data-lucide="alert-circle"></i>
        </div>
        <div class="alert-content">
          <div class="alert-message" id="mensagemTexto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" style="display:none;">
    <div class="loading-container">
      <i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i>
      <span class="loading-text">Processando sua pergunta...</span>
    </div>
  </div>

  <!-- Respostas -->
  <div id="respostasContainer"></div>
</div>

{% endblock %}

{% block extra_scripts %}

<script>
console.log('üöÄ SCRIPT CARREGADO!');

// Fun√ß√£o para mostrar mensagens personalizadas
function mostrarMensagem(texto, tipo = 'danger', duracao = 5000) {
    const container = document.getElementById('mensagemContainer');
    const alert = document.getElementById('mensagemAlert');
    const textoElement = document.getElementById('mensagemTexto');

    // Limpar classes anteriores
    alert.className = 'alert';
    alert.classList.add(`alert-${tipo}`);

    // Definir texto
    textoElement.textContent = texto;

    // Mostrar container
    container.style.display = 'block';

    // Auto-ocultar ap√≥s dura√ß√£o especificada
    setTimeout(() => {
        container.style.display = 'none';
    }, duracao);
}

function executarGeracao() {
    console.log('üéØ FUN√á√ÉO EXECUTADA!');

    // Pegar pergunta
    const pergunta = document.getElementById('perguntaInput').value.trim();

    if (!pergunta) {
        mostrarMensagem('‚ùå Digite uma pergunta primeiro!', 'warning');
        return;
    }

    console.log('üìù Pergunta:', pergunta);

    // Mostrar loading
    const botao = document.getElementById('botaoGerarResposta');
    botao.innerHTML = '<i data-lucide="loader-2"></i> Processando...';
    // Reinicializar √≠cones Lucide
    if (typeof initLucideIcons === 'function') {
        initLucideIcons();
    }
    botao.disabled = true;

    // Fazer requisi√ß√£o
    fetch('/api/responder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pergunta: pergunta })
    })
    .then(response => {
        console.log('üì° Resposta:', response.status);

        // Verificar se a resposta √© de erro de autentica√ß√£o
        if (response.status === 401) {
            mostrarMensagem('üîí Sua sess√£o expirou. Redirecionando para login...', 'warning');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            throw new Error('Sess√£o expirada');
        }

        // Verificar se a resposta n√£o √© OK
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Dados:', data);

        // Verificar se h√° erro na resposta
        if (data.error) {
            throw new Error(data.error);
        }

        // Verificar se a resposta existe
        if (!data.resposta) {
            throw new Error('Resposta n√£o encontrada nos dados retornados');
        }

        // Limpar formata√ß√£o desnecess√°ria da resposta
        let respostaLimpa = data.resposta;

        // Remover formata√ß√£o de atendimento
        respostaLimpa = respostaLimpa.replace(/üìû.*?\*\*Atendimento Assertiva\*\*.*?\n/g, '');
        respostaLimpa = respostaLimpa.replace(/\*\*Cliente:\*\*.*?\n/g, '');
        respostaLimpa = respostaLimpa.replace(/\*\*Atendente:\*\*.*?"/g, '');
        respostaLimpa = respostaLimpa.replace(/"/g, '');

        // Remover quebras de linha extras
        respostaLimpa = respostaLimpa.trim();

        // Mostrar resposta limpa
        document.getElementById('respostasContainer').innerHTML = `
            <div class="response-card fade-in">
                <div class="response-header">
                    <div class="response-title">
                        <i data-lucide="check-circle"></i>
                        <span>Resposta Gerada</span>
                    </div>
                    <button class="btn-copy" onclick="copiarResposta()">
                        <i data-lucide="copy"></i>
                        <span>Copiar</span>
                    </button>
                </div>
                <div class="response-content" id="respostaTexto">
                    ${respostaLimpa.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

        // Armazenar resposta limpa globalmente
        window.respostaParaCopiar = respostaLimpa;

        // Limpar campo
        document.getElementById('perguntaInput').value = '';

        // Mostrar mensagem de sucesso
        mostrarMensagem('‚úÖ Resposta gerada com sucesso!', 'success', 3000);

        // Scroll para resultado
        document.getElementById('respostasContainer').scrollIntoView({ behavior: 'smooth' });

        // Reinicializar √≠cones Lucide
        if (typeof initLucideIcons === 'function') {
            initLucideIcons();
        }
    })
    .catch(error => {
        console.error('‚ùå Erro:', error);
        mostrarMensagem('‚ùå Erro: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restaurar bot√£o
        botao.innerHTML = '<i data-lucide="send"></i> Gerar Resposta';
        // Reinicializar √≠cones Lucide
        if (typeof initLucideIcons === 'function') {
            initLucideIcons();
        }
        botao.disabled = false;
    });
}

// Fun√ß√£o para copiar resposta
function copiarResposta() {
    if (window.respostaParaCopiar) {
        navigator.clipboard.writeText(window.respostaParaCopiar).then(() => {
            // Feedback visual
            const botaoCopiar = document.querySelector('.btn-copy');
            const textoOriginal = botaoCopiar.innerHTML;
            botaoCopiar.innerHTML = '<i data-lucide="check"></i>';
            botaoCopiar.style.background = 'rgba(40, 167, 69, 0.8)';

            setTimeout(() => {
                botaoCopiar.innerHTML = '<i data-lucide="copy"></i>';
                botaoCopiar.style.background = 'rgba(255, 255, 255, 0.2)';
                // Reinicializar √≠cones Lucide
                if (typeof initLucideIcons === 'function') {
                    initLucideIcons();
                }
            }, 2000);
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            mostrarMensagem('‚ùå Erro ao copiar texto', 'danger');
        });
    }
}

// Suporte ao Ctrl+Enter
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('perguntaInput');
    if (textarea) {
        textarea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executarGeracao();
            }
        });
    }
});

console.log('‚úÖ Sistema pronto com funcionalidades avan√ßadas!');
</script>
{% endblock %}
