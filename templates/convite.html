{% extends "base.html" %}

{% set hide_navbar = true %}
{% set hide_sidebar = true %}

{% block title %}Definir Senha - Sistema Assertiva{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
{% endblock %}

{% block content %}
<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <div class="login-icon">
        <i data-lucide="key"></i>
      </div>
      <h1 class="login-title">Definir Senha</h1>
      <p class="login-subtitle">
        <strong>Email:</strong> {{ email }}
      </p>
    </div>

    <div class="login-body">
      <div class="login-form" id="formContainer">
        <form id="formSenha">
          <input type="hidden" id="token" value="{{ token }}">

          <div class="login-field">
            <label for="password" class="form-label">Nova senha</label>
            <input type="password" class="form-control" id="password" placeholder="Mínimo 8 caracteres" required minlength="8">
          </div>

          <div class="login-field">
            <label for="confirmPassword" class="form-label">Confirmar senha</label>
            <input type="password" class="form-control" id="confirmPassword" placeholder="Digite a senha novamente" required>
          </div>

          <button type="submit" class="ui-btn ui-btn--primary ui-btn--lg ui-btn--full" id="btnConfirmar">
            <i data-lucide="check"></i>
            Confirmar Senha
          </button>
        </form>

        <div id="erro" class="error-message" style="display:none;">
          <div class="alert alert-danger">
            <i data-lucide="alert-circle"></i>
            <span id="mensagemErro"></span>
          </div>
        </div>

        <div class="info-box">
          <div class="info-box__header">
            <i data-lucide="shield-check"></i>
            <span>Requisitos da senha:</span>
          </div>
          <ul class="info-box__list">
            <li>Mínimo de 8 caracteres</li>
            <li>Use uma senha forte e única</li>
            <li>Não compartilhe sua senha com ninguém</li>
          </ul>
        </div>
      </div>

      <div class="success-screen" id="sucessoContainer" style="display: none;">
        <div class="success-icon">
          <i data-lucide="check"></i>
        </div>
        <h2 class="success-title">Senha Criada com Sucesso!</h2>
        <p class="success-subtitle">Sua conta foi criada e você já pode fazer login no sistema.</p>
        <a href="{{ url_for('web.login') }}" class="ui-btn ui-btn--primary ui-btn--lg">
          <i data-lucide="log-in"></i>
          Fazer Login
        </a>
      </div>
    </div>
  </div>
</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('formSenha');
            const btnConfirmar = document.getElementById('btnConfirmar');
            const erroDiv = document.getElementById('erro');
            const formContainer = document.getElementById('formContainer');
            const sucessoContainer = document.getElementById('sucessoContainer');
            const loginBody = document.querySelector('.login-body');
            
            // Inicializar ícones Lucide
            if (typeof initLucideIcons === 'function') {
                initLucideIcons();
            }
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const token = document.getElementById('token').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validações
                if (password.length < 8) {
                    mostrarErro('A senha deve ter pelo menos 8 caracteres');
                    return;
                }
                
                if (password !== confirmPassword) {
                    mostrarErro('As senhas não coincidem');
                    return;
                }
                
                // Mostrar loading
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i data-lucide="loader-2" class="loading-spinner"></i> Criando senha...';
                erroDiv.style.display = 'none';
                
                // Reinicializar ícones
                if (typeof initLucideIcons === 'function') {
                    initLucideIcons();
                }
                
                try {
                    const response = await fetch('/api/aceitar-convite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ token, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.sucesso) {
                        // Mostrar sucesso
                        loginBody.style.display = 'none';
                        sucessoContainer.style.display = 'block';

                        // Reinicializar ícones
                        if (typeof initLucideIcons === 'function') {
                            initLucideIcons();
                        }
                        
                    } else {
                        mostrarErro(data.erro || 'Erro desconhecido');
                    }
                    
                } catch (error) {
                    mostrarErro('Erro de conexão: ' + error.message);
                }
                
                // Restaurar botão
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i data-lucide="check"></i> Confirmar Senha';
                
                // Reinicializar ícones
                if (typeof initLucideIcons === 'function') {
                    initLucideIcons();
                }
            });
            
            function mostrarErro(mensagem) {
                document.getElementById('mensagemErro').textContent = mensagem;
                erroDiv.style.display = 'block';
                
                // Reinicializar ícones
                if (typeof initLucideIcons === 'function') {
                    initLucideIcons();
                }
            }
            
            // Validação em tempo real
            document.getElementById('confirmPassword').addEventListener('input', function() {
                const password = document.getElementById('password').value;
                const confirmPassword = this.value;
                
                if (confirmPassword && password !== confirmPassword) {
                    this.setCustomValidity('As senhas não coincidem');
                } else {
                    this.setCustomValidity('');
                }
            });
        });
</script>
{% endblock %}
